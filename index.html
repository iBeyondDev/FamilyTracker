<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Work Tracker 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #0f172a; color: #f1f5f9; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { min-height: 100px; transition: all 0.2s; position: relative; }
        .calendar-day:hover:not(.empty) { background-color: #1e293b; border-color: #475569; z-index: 10; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .user-card.active { border: 2px solid #3b82f6; background-color: #1e293b; box-shadow: 0 0 15px rgba(59, 130, 246, 0.2); }
        .nav-btn.active { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-100">

    <header class="bg-slate-800 shadow-md z-20 shrink-0 border-b border-slate-700">
        <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col sm:flex-row gap-4 justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-2 rounded-lg shadow-lg">
                    <i class="fa-solid fa-cloud-arrow-up"></i>
                </div>
                <h1 class="text-xl font-bold text-slate-100">Family Tracker <span class="text-blue-500">2026</span></h1>
            </div>

            <div class="flex bg-slate-900 p-1 rounded-xl border border-slate-700">
                <button id="btnCalendarView" onclick="switchPage('calendar')" class="nav-btn active px-4 py-1.5 rounded-lg text-sm font-medium transition-all">
                    <i class="fa-solid fa-calendar-days mr-1"></i> Calendar
                </button>
                <button id="btnStatsView" onclick="switchPage('stats')" class="nav-btn px-4 py-1.5 rounded-lg text-sm font-medium transition-all text-slate-400">
                    <i class="fa-solid fa-chart-line mr-1"></i> Stats
                </button>
                <button id="btnConsistencyView" onclick="switchPage('consistency')" class="nav-btn px-4 py-1.5 rounded-lg text-sm font-medium transition-all text-slate-400">
                    <i class="fa-solid fa-fire mr-1"></i> Consistency
                </button>
            </div>

            <div class="flex gap-2">
                <div id="syncStatus" class="text-xs flex items-center gap-2 text-slate-400 bg-slate-900/50 px-3 py-1.5 rounded-full border border-slate-700">
                    <div class="w-2 h-2 rounded-full bg-yellow-500" id="statusDot"></div>
                    <span id="statusText">Connecting...</span>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 overflow-auto bg-slate-900 p-4 sm:p-6">
        <div id="calendarPage" class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-slate-800 rounded-xl border border-slate-700 p-4 flex justify-between items-center sticky top-0 z-10">
                    <button onclick="changeMonth(-1)" class="p-2 hover:bg-slate-700 rounded-full text-slate-400"><i class="fa-solid fa-chevron-left"></i></button>
                    <h2 class="text-xl font-bold w-48 text-center" id="currentMonthDisplay">Loading...</h2>
                    <button onclick="changeMonth(1)" class="p-2 hover:bg-slate-700 rounded-full text-slate-400"><i class="fa-solid fa-chevron-right"></i></button>
                </div>

                <div class="bg-slate-800 rounded-xl border border-slate-700 p-4 fade-in">
                    <div class="grid grid-cols-7 gap-4 mb-2 text-center text-xs font-semibold text-slate-500 uppercase">
                        <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                    </div>
                    <div id="calendarGrid" class="calendar-grid bg-slate-900/50 border border-slate-700/50 rounded-lg p-1"></div>
                </div>
                
                <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-4 flex items-center justify-between">
                    <div>
                        <h3 class="font-semibold text-slate-200">Logged in as</h3>
                        <p class="text-sm text-blue-400 font-bold" id="loggedUserDisplay"></p>
                    </div>
                    <button onclick="openLogModal(new Date().toISOString().split('T')[0])" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg shadow-lg font-medium border border-blue-500">
                        Log Hours
                    </button>
                </div>
            </div>

            <div class="space-y-6">
                <div class="bg-slate-800 rounded-xl border border-slate-700 p-6 flex flex-col h-full">
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-users text-slate-400"></i> Family Dashboard
                    </h3>
                    <div id="usersList" class="space-y-3 flex-1 overflow-y-auto no-scrollbar"></div>
                </div>
            </div>
        </div>

        <div id="statsPage" class="max-w-7xl mx-auto hidden fade-in space-y-6">
            <h2 class="text-2xl font-bold text-white" id="statsMonthTitle">Month Statistics</h2>
            <div id="personAvgGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
            <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700">
                <canvas id="statsChart" class="h-80 w-full"></canvas>
            </div>
        </div>

        <div id="consistencyPage" class="max-w-7xl mx-auto hidden fade-in space-y-6">
            <h2 class="text-2xl font-bold text-white">Consistency (≥ 2h)</h2>
            <div id="consistencyGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </div>
    </main>

    <div id="logModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="bg-slate-800 rounded-2xl w-full max-w-md mx-4 border border-slate-700 p-6 space-y-5">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold text-white">Log for <span id="modalUserName" class="text-blue-400"></span></h3>
                <button onclick="closeModal()" class="text-slate-400"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="modalDateDisplay" class="text-sm text-slate-400"></div>
            <input type="number" id="hoursInput" step="0.5" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white" placeholder="Hours...">
            <textarea id="notesInput" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white" placeholder="Notes..."></textarea>
            <div class="flex justify-end gap-3">
                <button onclick="deleteEntry()" id="deleteBtn" class="px-4 py-2 text-red-400 hidden">Delete</button>
                <button onclick="saveEntry()" class="px-6 py-2 bg-blue-600 text-white rounded-lg">Save</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'family-tracker-2026';
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const USERS = ['Mohammad', 'Fadwa', 'Alia', 'Tasneem'];
        const USER_COLORS = { 'Mohammad': 'bg-blue-500', 'Fadwa': 'bg-purple-500', 'Alia': 'bg-pink-500', 'Tasneem': 'bg-emerald-500' };
        
        let appData = {}; 
        let currentUser = localStorage.getItem('selectedUserIdentity') || USERS[0];
        let currentDate = new Date();
        let selectedDateForModal = null;
        let statsChartInstance = null;
        let authReady = false;

        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth initialization failed:", error);
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                authReady = true;
                document.getElementById('statusText').innerText = "Synced";
                document.getElementById('statusDot').classList.replace('bg-yellow-500', 'bg-green-500');
                listenToData();
            } else {
                authReady = false;
                document.getElementById('statusText').innerText = "Connecting...";
                document.getElementById('statusDot').classList.replace('bg-green-500', 'bg-yellow-500');
            }
        });

        function listenToData() {
            if (!authReady) return;
            // Rule 1: Always use /artifacts/{appId}/public/data/{collectionName}
            const dataPath = collection(db, 'artifacts', appId, 'public', 'data', 'workLogs');
            
            onSnapshot(dataPath, (snapshot) => {
                // Reset local structure
                USERS.forEach(u => appData[u] = {});
                snapshot.forEach(doc => {
                    const [user, date] = doc.id.split('_');
                    if (USERS.includes(user)) {
                        appData[user][date] = doc.data();
                    }
                });
                renderUI();
            }, (err) => {
                console.error("Firestore Listen Error:", err);
                document.getElementById('statusText').innerText = "Permission Error";
            });
        }

        window.switchPage = (page) => {
            ['calendar', 'stats', 'consistency'].forEach(p => {
                document.getElementById(`${p}Page`).classList.toggle('hidden', p !== page);
                document.getElementById(`btn${p.charAt(0).toUpperCase() + p.slice(1)}View`).classList.toggle('active', p === page);
            });
            if(page === 'stats') renderStats();
            if(page === 'consistency') renderConsistency();
        };

        window.selectUser = (user) => {
            currentUser = user;
            localStorage.setItem('selectedUserIdentity', user);
            renderUI();
        };

        window.changeMonth = (delta) => {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderUI();
        };

        function renderUI() {
            document.getElementById('loggedUserDisplay').innerText = currentUser;
            renderUsers();
            renderCalendar();
            if (!document.getElementById('statsPage').classList.contains('hidden')) renderStats();
            if (!document.getElementById('consistencyPage').classList.contains('hidden')) renderConsistency();
        }

        function renderUsers() {
            const container = document.getElementById('usersList');
            container.innerHTML = '';
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            
            USERS.forEach(user => {
                let total = Object.entries(appData[user] || {})
                    .filter(([date]) => {
                        const d = new Date(date);
                        return d.getMonth() === month && d.getFullYear() === year;
                    })
                    .reduce((sum, [_, v]) => sum + v.hours, 0);

                const isActive = user === currentUser;
                const userItem = document.createElement('div');
                userItem.className = `user-card p-4 rounded-xl cursor-pointer border-2 transition-all ${isActive ? 'active border-blue-500' : 'border-transparent bg-slate-800/40'}`;
                userItem.onclick = () => selectUser(user);
                userItem.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="font-bold">${user}</span>
                        <span class="text-lg font-black">${total}h</span>
                    </div>
                `;
                container.appendChild(userItem);
            });
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            document.getElementById('currentMonthDisplay').innerText = new Intl.DateTimeFormat('en-US', {month:'long', year:'numeric'}).format(currentDate);

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startingDay = new Date(year, month, 1).getDay();

            for (let i = 0; i < startingDay; i++) grid.appendChild(document.createElement('div'));

            for (let d = 1; d <= daysInMonth; d++) {
                const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const dayEl = document.createElement('div');
                dayEl.className = `calendar-day rounded-lg p-2 cursor-pointer bg-slate-800 border border-slate-700 flex flex-col justify-between`;
                
                let bars = '';
                USERS.forEach(u => {
                    const entry = appData[u]?.[dateKey];
                    if (entry) {
                        bars += `<div class="h-3 w-full ${USER_COLORS[u]} rounded-sm mb-0.5 opacity-80" title="${u}: ${entry.hours}h"></div>`;
                    }
                });

                dayEl.innerHTML = `<span class="text-xs text-slate-500">${d}</span><div class="mt-auto">${bars}</div>`;
                dayEl.onclick = () => openLogModal(dateKey);
                grid.appendChild(dayEl);
            }
        }

        window.openLogModal = (dateKey) => {
            selectedDateForModal = dateKey;
            const entry = appData[currentUser]?.[dateKey];
            document.getElementById('modalUserName').innerText = currentUser;
            document.getElementById('modalDateDisplay').innerText = dateKey;
            document.getElementById('hoursInput').value = entry ? entry.hours : '';
            document.getElementById('notesInput').value = entry?.notes || '';
            document.getElementById('deleteBtn').classList.toggle('hidden', !entry);
            document.getElementById('logModal').classList.remove('hidden');
        };

        window.closeModal = () => document.getElementById('logModal').classList.add('hidden');

        window.saveEntry = async () => {
            if (!authReady) return;
            const hours = parseFloat(document.getElementById('hoursInput').value);
            if (isNaN(hours)) return;
            
            // Unique docId per user+date to avoid indexing requirements
            const docId = `${currentUser}_${selectedDateForModal}`;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'workLogs', docId);
            
            await setDoc(docRef, { 
                hours, 
                notes: document.getElementById('notesInput').value, 
                timestamp: Date.now() 
            });
            closeModal();
        };

        window.deleteEntry = async () => {
            if (!authReady) return;
            const docId = `${currentUser}_${selectedDateForModal}`;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'workLogs', docId);
            await deleteDoc(docRef);
            closeModal();
        };

        function renderStats() {
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const avgGrid = document.getElementById('personAvgGrid');
            avgGrid.innerHTML = '';

            let labels = Array.from({length: daysInMonth}, (_, i) => i + 1);
            let datasets = [];

            USERS.forEach(u => {
                const logs = appData[u] || {};
                const monthlyTotal = Object.entries(logs)
                    .filter(([d]) => new Date(d).getMonth() === month && new Date(d).getFullYear() === year)
                    .reduce((s, [_, v]) => s + v.hours, 0);

                avgGrid.innerHTML += `
                    <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                        <div class="text-xs text-slate-500 uppercase">${u} Avg</div>
                        <div class="text-xl font-bold">${(monthlyTotal / daysInMonth).toFixed(1)}h</div>
                    </div>
                `;

                let dailyData = Array(daysInMonth).fill(0);
                Object.entries(logs).forEach(([date, v]) => {
                    const d = new Date(date);
                    if(d.getMonth() === month && d.getFullYear() === year) {
                        dailyData[d.getDate()-1] = v.hours;
                    }
                });

                datasets.push({ 
                    label: u, 
                    data: dailyData, 
                    borderColor: u === 'Mohammad' ? '#3b82f6' : u === 'Fadwa' ? '#a855f7' : u === 'Alia' ? '#ec4899' : '#10b981', 
                    tension: 0.4 
                });
            });

            const ctx = document.getElementById('statsChart').getContext('2d');
            if (statsChartInstance) statsChartInstance.destroy();
            statsChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: { 
                    maintainAspectRatio: false, 
                    plugins: { legend: { labels: { color: '#94a3b8' } } },
                    scales: { 
                        y: { ticks: { color: '#64748b' }, grid: { color: '#1e293b' } },
                        x: { ticks: { color: '#64748b' }, grid: { display: false } }
                    }
                }
            });
        }

        function renderConsistency() {
            const grid = document.getElementById('consistencyGrid');
            grid.innerHTML = '';
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            USERS.forEach(user => {
                let consistentCount = 0;
                let longestStreak = 0;
                let currentStreak = 0;
                let history = [];

                for (let d = 1; d <= daysInMonth; d++) {
                    const key = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const hrs = appData[user]?.[key]?.hours || 0;
                    const isOk = hrs >= 2;
                    if (isOk) {
                        consistentCount++;
                        currentStreak++;
                        if (currentStreak > longestStreak) longestStreak = currentStreak;
                    } else {
                        currentStreak = 0;
                    }
                    history.push(isOk);
                }

                grid.innerHTML += `
                    <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700">
                        <div class="flex justify-between items-center mb-4">
                            <span class="font-bold text-white">${user}</span>
                            <div class="flex gap-4">
                                <div class="text-right">
                                    <p class="text-[10px] text-slate-500 uppercase font-bold">Days ≥2h</p>
                                    <p class="text-blue-400 font-black">${consistentCount}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-[10px] text-slate-500 uppercase font-bold">Streak</p>
                                    <p class="text-orange-400 font-black">${longestStreak}d</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-1">
                            ${history.map((ok, i) => `<div class="w-6 h-6 rounded flex items-center justify-center text-[10px] ${ok ? USER_COLORS[user] : 'bg-slate-700/50'}">${i+1}</div>`).join('')}
                        </div>
                    </div>
                `;
            });
        }

        initAuth();
    </script>
</body>
</html>
